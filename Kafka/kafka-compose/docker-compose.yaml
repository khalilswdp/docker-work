services:
  kafka:
    image: "${REGISTRY_PREFIX:-docker.io}/${KAFKA_IMAGE:-apache/kafka}:${KAFKA_TAG:-latest}"
    container_name: "${KAFKA_CONTAINER_NAME:-kafka-local}"
    hostname: "${KAFKA_HOSTNAME:-kafka}"

    ports:
      # Host -> container external listener
      - "${KAFKA_EXTERNAL_HOST_PORT:-29092}:${EXTERNAL_LISTENER_PORT:-9092}"

    environment:
      # ============================================================
      # IMPORTANT (apache/kafka):
      # If you override ANY broker config via env vars, none of the
      # image defaults are used. We therefore specify the full required
      # KRaft combined-mode set + single-node replication settings.
      # ============================================================

      # -----------------------------
      # KRaft combined mode (required set)
      # -----------------------------
      KAFKA_NODE_ID: "${KAFKA_NODE_ID:-1}"
      KAFKA_PROCESS_ROLES: "broker,controller"

      # KRaft controller quorum (single node)
      KAFKA_CONTROLLER_LISTENER_NAMES: "${CONTROLLER_LISTENER_NAME:-CONTROLLER}"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "${KAFKA_NODE_ID:-1}@${KAFKA_HOSTNAME:-kafka}:${CONTROLLER_LISTENER_PORT:-9093}"

      # Dual listeners: INTERNAL (docker network), EXTERNAL (host), + CONTROLLER
      KAFKA_LISTENERS: "${INTERNAL_LISTENER_NAME:-INTERNAL}://:${INTERNAL_LISTENER_PORT:-19092},${EXTERNAL_LISTENER_NAME:-EXTERNAL}://:${EXTERNAL_LISTENER_PORT:-9092},${CONTROLLER_LISTENER_NAME:-CONTROLLER}://:${CONTROLLER_LISTENER_PORT:-9093}"
      KAFKA_ADVERTISED_LISTENERS: "${INTERNAL_LISTENER_NAME:-INTERNAL}://${KAFKA_HOSTNAME:-kafka}:${INTERNAL_LISTENER_PORT:-19092},${EXTERNAL_LISTENER_NAME:-EXTERNAL}://${KAFKA_EXTERNAL_HOST:-localhost}:${KAFKA_EXTERNAL_HOST_PORT:-29092}"

      # Map listener -> security protocol (EXTERNAL can be SASL_PLAINTEXT)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "${CONTROLLER_LISTENER_NAME:-CONTROLLER}:PLAINTEXT,${INTERNAL_LISTENER_NAME:-INTERNAL}:PLAINTEXT,${EXTERNAL_LISTENER_NAME:-EXTERNAL}:${EXTERNAL_SECURITY_PROTOCOL:-SASL_PLAINTEXT}"

      # Internal broker traffic uses INTERNAL (PLAINTEXT) by default
      KAFKA_INTER_BROKER_LISTENER_NAME: "${INTERNAL_LISTENER_NAME:-INTERNAL}"

      # Optional: fixed cluster ID (if set)
      # (The image prints “Using provided cluster id …” when you set it.)
      KAFKA_CLUSTER_ID: "${KAFKA_CLUSTER_ID:-}"

      # ============================================================
      # Single-node required overrides (from apache/kafka docs example)
      # ============================================================
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "${OFFSETS_TOPIC_REPLICATION_FACTOR:-1}"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "${TXN_STATE_LOG_REPLICATION_FACTOR:-1}"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "${TXN_STATE_LOG_MIN_ISR:-1}"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "${GROUP_INITIAL_REBALANCE_DELAY_MS:-0}"

      # ============================================================
      # Broker defaults
      # ============================================================
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "${AUTO_CREATE_TOPICS:-false}"
      KAFKA_NUM_PARTITIONS: "${NUM_PARTITIONS:-3}"
      KAFKA_LOG_RETENTION_HOURS: "${LOG_RETENTION_HOURS:-168}"

      # ============================================================
      # SASL/SCRAM (EXTERNAL listener only; INTERNAL stays PLAINTEXT)
      # - We always set these values, but they only matter when:
      #   EXTERNAL_SECURITY_PROTOCOL=SASL_PLAINTEXT and ENABLE_SASL=true
      # Kafka requires JAAS config per listener+mechanism.
      # For SCRAM brokers, a minimal JAAS stanza is:
      #   ScramLoginModule required;
      # ============================================================

      # -----------------------------
      # SASL / SCRAM (THIS is the missing piece that caused your crash)
      #
      # Kafka expects:
      #  - listener.name.<listener>.sasl.enabled.mechanisms
      #  - listener.name.<listener>.<mechanism>.sasl.jaas.config
      #
      # Mechanism SCRAM-SHA-512 becomes SCRAM_SHA_512 in env-var form.
      # -----------------------------
      KAFKA_SASL_ENABLED_MECHANISMS: "${SASL_MECHANISM:-SCRAM-SHA-512}"

      # ============================================================
      # Authorizer / ACLs (KRaft authorizer)
      # Enable with ENABLE_AUTHORIZER=true (init.sh applies ACLs too)
      # ============================================================
      # Values are safe defaults; unused keys are ignored.
      KAFKA_LISTENER_NAME_EXTERNAL_SASL_ENABLED_MECHANISMS: "${SASL_MECHANISM:-SCRAM-SHA-512}"
      KAFKA_LISTENER_NAME_OUTSIDE_SASL_ENABLED_MECHANISMS: "${SASL_MECHANISM:-SCRAM-SHA-512}"

      # -----------------------------
      # Authorizer / ACLs (KRaft)
      # NOTE: we always set it; if you want it OFF, set ENABLE_AUTHORIZER=false
      # and ALLOW_EVERYONE_IF_NO_ACL_FOUND=true and remove ACL usage.
      # -----------------------------
      KAFKA_AUTHORIZER_CLASS_NAME: "org.apache.kafka.metadata.authorizer.StandardAuthorizer"
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: "${ALLOW_EVERYONE_IF_NO_ACL_FOUND:-false}"
      KAFKA_SUPER_USERS: "${SUPER_USERS:-User:ANONYMOUS;User:kafka_app}"

      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"

      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: "http://${SCHEMA_REGISTRY_HOSTNAME:-schema-registry}:8081"

    volumes:
      - kafka_data:/var/lib/kafka/data
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf:ro


    healthcheck:
      # Probe INTERNAL listener from inside container (stable)
      test: ["CMD-SHELL", "bash -ec 'echo > /dev/tcp/127.0.0.1/${INTERNAL_LISTENER_PORT:-19092}'"]
      interval: 10s
      timeout: 3s
      retries: 30

  kafka-setup:
    image: "${REGISTRY_PREFIX:-docker.io}/${KAFKA_IMAGE:-apache/kafka}:${KAFKA_TAG:-latest}"
    container_name: "${KAFKA_SETUP_CONTAINER_NAME:-kafka-setup}"
    depends_on:
      kafka:
        condition: service_healthy

    environment:
      # Bootstrap inside docker network (INTERNAL listener)
      BOOTSTRAP: "${BOOTSTRAP_INTERNAL:-kafka:19092}"

      # Feature toggles
      ENABLE_SASL: "${ENABLE_SASL:-true}"
      ENABLE_AUTHORIZER: "${ENABLE_AUTHORIZER:-true}"
      APPLY_ACLS: "${APPLY_ACLS:-true}"

      # SCRAM user to create/update (used if ENABLE_SASL=true)
      SASL_MECHANISM: "${SASL_MECHANISM:-SCRAM-SHA-512}"
      APP_USER: "${APP_USER:-kafka_app}"
      APP_PASS: "${APP_PASS:-kafka_app_password}"

      # Topics
      TOPIC_1: "${TOPIC_1:-topic_one}"
      TOPIC_2: "${TOPIC_2:-topic_two}"
      TOPIC_PARTITIONS: "${TOPIC_PARTITIONS:-3}"
      TOPIC_RF: "${TOPIC_RF:-1}"

      # Group ACL target
      APP_GROUP: "${APP_GROUP:-kafka_app_group}"

    volumes:
      - ./init.sh:/init.sh:ro
    entrypoint: ["bash", "-lc", "/init.sh"]

  kafka-ui:
    image: "${REGISTRY_PREFIX:-docker.io}/${KAFKA_UI_IMAGE:-provectuslabs/kafka-ui}:${KAFKA_UI_TAG:-latest}"
    container_name: "${KAFKA_UI_CONTAINER_NAME:-kafka-ui-local}"
    depends_on:
      kafka:
        condition: service_healthy

    ports:
      - "${KAFKA_UI_PORT:-8080}:8080"

    environment:
      # UI connects over INTERNAL PLAINTEXT by default (simple + reliable)
      KAFKA_CLUSTERS_0_NAME: "${KAFKA_CLUSTER_NAME:-local}"
      # UI uses INTERNAL PLAINTEXT (simple + reliable)
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "${BOOTSTRAP_INTERNAL:-kafka:19092}"

      # UI web login (separate from Kafka auth)
      AUTH_TYPE: "${KAFKA_UI_AUTH_TYPE:-DISABLED}"
      SPRING_SECURITY_USER_NAME: "${KAFKA_UI_USER:-admin}"
      SPRING_SECURITY_USER_PASSWORD: "${KAFKA_UI_PASSWORD:-admin123}"

  schema-registry:
    image: "${REGISTRY_PREFIX:-docker.io}/${SCHEMA_REGISTRY_IMAGE:-confluentinc/cp-schema-registry}:${SCHEMA_REGISTRY_TAG:-latest}"
    container_name: "${SCHEMA_REGISTRY_CONTAINER_NAME:-schema-registry-local}"
    hostname: "${SCHEMA_REGISTRY_HOSTNAME:-schema-registry}"
    depends_on:
      kafka:
        condition: service_healthy

    ports:
      - "${SCHEMA_REGISTRY_PORT:-8081}:8081"

    environment:
      # Connect to Kafka over INTERNAL PLAINTEXT
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "${BOOTSTRAP_INTERNAL:-kafka:19092}"

      # Registry HTTP API
      SCHEMA_REGISTRY_HOST_NAME: "${SCHEMA_REGISTRY_HOSTNAME:-schema-registry}"
      SCHEMA_REGISTRY_LISTENERS: "http://0.0.0.0:8081"

      # Optional: keep things explicit
      SCHEMA_REGISTRY_LOG4J_ROOT_LOGLEVEL: "${SCHEMA_REGISTRY_LOG_LEVEL:-INFO}"

    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://127.0.0.1:8081/subjects >/dev/null || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 30

  schema-registry-ui:
    image: "${REGISTRY_PREFIX:-docker.io}/${SCHEMA_REGISTRY_UI_IMAGE:-landoop/schema-registry-ui}:${SCHEMA_REGISTRY_UI_TAG:-latest}"
    container_name: "${SCHEMA_REGISTRY_UI_CONTAINER_NAME:-schema-registry-ui-local}"
    depends_on:
      schema-registry:
        condition: service_healthy

    ports:
      - "${SCHEMA_REGISTRY_UI_PORT:-8000}:8000"

    environment:
      # Point the UI to your registry inside the docker network
      SCHEMAREGISTRY_URL: "http://${SCHEMA_REGISTRY_HOSTNAME:-schema-registry}:8081"

      # Optional but commonly needed for browser/API calls
      PROXY: "true"

volumes:
  kafka_data: