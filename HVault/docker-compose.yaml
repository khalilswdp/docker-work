services:
  vault:
    image: hashicorp/vault:1.16
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    command: [ "vault", "server", "-dev" ]
    healthcheck:
      test: [ "CMD", "sh", "-c", "wget -qO- http://127.0.0.1:8200/v1/sys/health | grep -q '\"initialized\":true'" ]
      interval: 3s
      timeout: 2s
      retries: 30

  # One-shot container that enables KV v2 + writes a few secrets
  vault-init:
    image: hashicorp/vault:1.16
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
    entrypoint: ["/bin/sh", "-c"]
    command: |
      set -e
      echo "Enabling KV v2 at path 'secret/' (idempotent)..."
      vault secrets enable -path=secret kv-v2 || true

      echo "Writing sample secrets to secret/data/myapp..."
      vault kv put secret/myapp \
        db.username="demo_user" \
        db.password="demo_pass" \
        ssh.host="example.internal" \
        ssh.port="22"

      echo "Done."
    restart: "no"

  app:
    build: ./app
    container_name: spring-app
    depends_on:
      vault-init:
        condition: service_completed_successfully
    environment:
      # Spring Cloud Vault settings
      SPRING_CLOUD_VAULT_URI: "http://vault:8200"
      SPRING_CLOUD_VAULT_TOKEN: "root"
      SPRING_CLOUD_VAULT_KV_ENABLED: "true"
      SPRING_CLOUD_VAULT_KV_BACKEND: "secret"
      SPRING_CLOUD_VAULT_KV_DEFAULT_CONTEXT: "myapp"