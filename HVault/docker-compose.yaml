services:
  vault:
    image: hashicorp/vault:1.16
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    command: [ "vault", "server", "-dev" ]
    healthcheck:
      test: [ "CMD", "sh", "-c", "wget -qO- http://127.0.0.1:8200/v1/sys/health | grep -q '\"initialized\":true'" ]
      interval: 3s
      timeout: 2s
      retries: 30

  # One-shot container that enables KV v2 + writes a few secrets
  vault-init:
    image: hashicorp/vault:1.16
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
    volumes:
      - ./init-vault.sh:/init-vault.sh:ro
    entrypoint: [ "/bin/sh", "-ec" ]
    command: "/init-vault.sh"
    restart: "no"

  app:
    build:
      context: ./app
      secrets:
        - maven_settings
    container_name: spring-app
    depends_on:
      vault-init:
        condition: service_completed_successfully
    environment:
      # Spring Cloud Vault settings
      SPRING_CONFIG_IMPORT: "vault://"
      SPRING_CLOUD_VAULT_URI: "http://vault:8200"
      SPRING_CLOUD_VAULT_AUTHENTICATION: "TOKEN"
      SPRING_CLOUD_VAULT_TOKEN: "root"
      SPRING_CLOUD_VAULT_KV_ENABLED: "true"
      SPRING_CLOUD_VAULT_KV_BACKEND: "secret"
      SPRING_CLOUD_VAULT_KV_DEFAULT_CONTEXT: "myapp"

secrets:
  maven_settings:
    file: ~/.m2/settings.xml